server:
  http_listen_port: 9080
  grpc_listen_port: 0

# File to store positions so that restarted promtail picks up where it left off.
positions:
  filename: /tmp/positions.yaml

clients:
  - url: "http://${MAIN_INSTANCE_PRIVATE_IP}:3100/loki/api/v1/push"
    tenant_id: "default"

scrape_configs:
  # Scrape system logs from /var/log
  - job_name: system-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          host: client
          __path__: /var/log/**/*.log

  # Scrape Docker container logs
  - job_name: docker-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          host: client
          __path__: /var/lib/docker/containers/*/*.log

    pipeline_stages:
      - timestamp:
          source: time
          format: RFC3339Nano
          fallback_formats:
            - RFC3339
            - UnixMs
          location: UTC
      
      # Debug what we have before Docker stage
      - output:
          source: labels
      
      - docker: {}
      
      # Debug after Docker stage  
      - output:
          source: labels
      
      - regex:
          expression: '.*\/(?P<container_id>[a-f0-9]{64})\.log'
      
      # Debug after regex
      - output:
          source: labels
      
      - docker:
          source: container_id
      
      # Debug after second Docker stage
      - output:
          source: labels
      
      - labels:
          container:
      
      # Final debug
      - output:
          source: labels
      
      - labeldrop:
          - filename
          - container_id
